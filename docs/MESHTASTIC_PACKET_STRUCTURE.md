# ะกัััะบัััะฐ ะฟะฐะบะตัะพะฒ Meshtastic

ะะพะบัะผะตะฝัะฐัะธั ะฟะพ ััััะบัััะต ะฟะฐะบะตัะพะฒ Meshtastic, ะฟะพะปัะผ protobuf ะธ ะทะฝะฐัะตะฝะธัะผ portnum.

## ะะฑัะฐั ััััะบัััะฐ MQTT ะฟะฐะบะตัะฐ

Meshtastic ะธัะฟะพะปัะทัะตั protobuf ะดะปั ัะตัะธะฐะปะธะทะฐัะธะธ ะดะฐะฝะฝัั. ะัะธ ะฟัะฑะปะธะบะฐัะธะธ ะฒ MQTT ะฟะฐะบะตั ะพะฑะพัะฐัะธะฒะฐะตััั ะฒ `ServiceEnvelope`:

```
ServiceEnvelope
โโโ packet (MeshPacket)
โ   โโโ id (uint32) - ัะฝะธะบะฐะปัะฝัะน ID ัะพะพะฑัะตะฝะธั
โ   โโโ from (uint32) - ID ะฝะพะดั-ะพัะฟัะฐะฒะธัะตะปั (hex ัะพัะผะฐั: !12345678)
โ   โโโ to (uint32) - ID ะฝะพะดั-ะฟะพะปััะฐัะตะปั (0xFFFFFFFF = "ะัะตะผ")
โ   โโโ sender (uint32) - ID ะฝะพะดั, ะบะพัะพัะฐั ัะตััะฐะฝัะปะธัะพะฒะฐะปะฐ ัะพะพะฑัะตะฝะธะต
โ   โโโ hop_start (uint32) - ะฝะฐัะฐะปัะฝะพะต ะทะฝะฐัะตะฝะธะต hop limit
โ   โโโ hop_limit (uint32) - ะผะฐะบัะธะผะฐะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ัะตััะฐะฝัะปััะธะน
โ   โโโ rx_time (uint32) - ะฒัะตะผั ะฟะพะปััะตะฝะธั ะฟะฐะบะตัะฐ (Unix timestamp)
โ   โโโ rx_rssi (int32) - ััะพะฒะตะฝั ัะธะณะฝะฐะปะฐ ะฟัะธ ะฟัะธะตะผะต (dBm)
โ   โโโ rx_snr (float) - ะพัะฝะพัะตะฝะธะต ัะธะณะฝะฐะป/ััะผ ะฟัะธ ะฟัะธะตะผะต (dB)
โ   โโโ rx_snr (float) - ะพัะฝะพัะตะฝะธะต ัะธะณะฝะฐะป/ััะผ ะฟัะธ ะฟัะธะตะผะต (dB)
โ   โโโ decoded (Data)
โ       โโโ portnum (PortNum enum) - ัะธะฟ ะฟัะธะปะพะถะตะฝะธั/ะดะฐะฝะฝัั
โ       โโโ payload (bytes, base64) - ะดะตะบะพะดะธัะพะฒะฐะฝะฝัะต ะดะฐะฝะฝัะต ะฟัะธะปะพะถะตะฝะธั
โโโ channel_id (string) - ID ะบะฐะฝะฐะปะฐ
```

## ะะพะปั ััะพะฒะฝั Packet (MeshPacket)

### ะัะฝะพะฒะฝัะต ะฟะพะปั ะธะดะตะฝัะธัะธะบะฐัะธะธ

- **`id`** (uint32): ะฃะฝะธะบะฐะปัะฝัะน ะธะดะตะฝัะธัะธะบะฐัะพั ัะพะพะฑัะตะฝะธั. ะัะฟะพะปัะทัะตััั ะดะปั ะณััะฟะฟะธัะพะฒะบะธ ัะพะพะฑัะตะฝะธะน, ะฟะพะปััะตะฝะฝัั ัะฐะทะฝัะผะธ ะฝะพะดะฐะผะธ.
- **`from`** (uint32): ID ะฝะพะดั-ะพัะฟัะฐะฒะธัะตะปั ะฒ hex ัะพัะผะฐัะต (ะฝะฐะฟัะธะผะตั, `!698566d0`). ะญัะพ ะพัะธะณะธะฝะฐะปัะฝัะน ะพัะฟัะฐะฒะธัะตะปั ัะพะพะฑัะตะฝะธั.
- **`to`** (uint32): ID ะฝะพะดั-ะฟะพะปััะฐัะตะปั. ะะฝะฐัะตะฝะธะต `0xFFFFFFFF` (4294967295) ะพะทะฝะฐัะฐะตั "ะัะตะผ" (broadcast).
- **`sender`** (uint32): ID ะฝะพะดั, ะบะพัะพัะฐั ะฟะพัะปะตะดะฝะตะน ัะตััะฐะฝัะปะธัะพะฒะฐะปะฐ ัะพะพะฑัะตะฝะธะต. ะัะปะธัะฐะตััั ะพั `from`, ะตัะปะธ ัะพะพะฑัะตะฝะธะต ะฑัะปะพ ัะตััะฐะฝัะปะธัะพะฒะฐะฝะพ.

### ะะพะปั ะผะฐัััััะธะทะฐัะธะธ

- **`hop_start`** (uint32): ะะฐัะฐะปัะฝะพะต ะทะฝะฐัะตะฝะธะต hop limit ะฟัะธ ะพัะฟัะฐะฒะบะต.
- **`hop_limit`** (uint32): ะะฐะบัะธะผะฐะปัะฝะพะต ะบะพะปะธัะตััะฒะพ ัะตััะฐะฝัะปััะธะน (hops). ะฃะผะตะฝััะฐะตััั ะฝะฐ 1 ะฟัะธ ะบะฐะถะดะพะน ัะตััะฐะฝัะปััะธะธ.
- **`hops_away`** (ะฒััะธัะปัะตััั): ะะพะปะธัะตััะฒะพ ัะตััะฐะฝัะปััะธะน = `hop_start - hop_limit`. ะัะปะธ ะพััะธัะฐัะตะปัะฝะพะต ะธะปะธ ะพััััััะฒัะตั, ััะธัะฐะตััั ะฟััะผะพะน ะดะพััะฐะฒะบะพะน (0 hops).

### ะะพะปั ะบะฐัะตััะฒะฐ ัะธะณะฝะฐะปะฐ (ะฟัะธ ะฟัะธะตะผะต)

- **`rx_time`** (uint32): Unix timestamp ะฒัะตะผะตะฝะธ ะฟะพะปััะตะฝะธั ะฟะฐะบะตัะฐ ะฝะพะดะพะน.
- **`rx_rssi`** (int32): ะฃัะพะฒะตะฝั ัะธะณะฝะฐะปะฐ ะฟัะธ ะฟัะธะตะผะต ะฒ dBm (ะพััะธัะฐัะตะปัะฝะพะต ัะธัะปะพ, ะฝะฐะฟัะธะผะตั -80).
  - ๐ข ะัะปะธัะฝัะน: > -80 dBm
  - ๐ก ะะพัะผะฐะปัะฝัะน: -80 ะดะพ -100 dBm
  - ๐ด ะะปะพัะพะน: -100 ะดะพ -120 dBm
  - โซ ะัะตะฝั ะฟะปะพัะพะน: < -120 dBm
- **`rx_snr`** (float): ะัะฝะพัะตะฝะธะต ัะธะณะฝะฐะป/ััะผ ะฟัะธ ะฟัะธะตะผะต ะฒ dB (ะผะพะถะตั ะฑััั ะพััะธัะฐัะตะปัะฝัะผ ะดะปั LoRa).
  - ๐ข ะัะปะธัะฝัะน: >= 10 dB
  - ๐ก ะฅะพัะพัะธะน: 5 ะดะพ 10 dB
  - ๐ ะฃะดะพะฒะปะตัะฒะพัะธัะตะปัะฝัะน: 0 ะดะพ 5 dB
  - ๐ด ะะปะพัะพะน: -5 ะดะพ 0 dB
  - โซ ะัะตะฝั ะฟะปะพัะพะน: < -5 dB

### ะะพะปั ะดะตะบะพะดะธัะพะฒะฐะฝะฝัั ะดะฐะฝะฝัั (decoded)

- **`portnum`** (PortNum enum): ะขะธะฟ ะฟัะธะปะพะถะตะฝะธั/ะดะฐะฝะฝัั. ะะฟัะตะดะตะปัะตั ัะพัะผะฐั `payload`.
- **`payload`** (bytes, base64): ะะตะบะพะดะธัะพะฒะฐะฝะฝัะต ะดะฐะฝะฝัะต ะฟัะธะปะพะถะตะฝะธั ะฒ ัะพัะผะฐัะต base64.

## PortNum (ัะธะฟั ะฟัะธะปะพะถะตะฝะธะน)

PortNum ะพะฟัะตะดะตะปัะตั ัะธะฟ ะดะฐะฝะฝัั ะฒ `payload`. ะะฝะฐัะตะฝะธั ะธะท enum `PortNum` ะฒ `mesh_pb2`:

### ะขะตะบััะพะฒัะต ัะพะพะฑัะตะฝะธั

- **`TEXT_MESSAGE_APP`** (1): ะะฑััะฝะพะต ัะตะบััะพะฒะพะต ัะพะพะฑัะตะฝะธะต
  - `payload`: UTF-8 ัััะพะบะฐ ั ัะตะบััะพะผ ัะพะพะฑัะตะฝะธั
  - ะัะฟะพะปัะทัะตััั ะดะปั: ะปะธัะฝัะต ัะพะพะฑัะตะฝะธั, ะณััะฟะฟะพะฒัะต ัะฐัั

- **`TEXT_MESSAGE_COMPRESSED_APP`** (2): ะกะถะฐัะพะต ัะตะบััะพะฒะพะต ัะพะพะฑัะตะฝะธะต
  - `payload`: ะกะถะฐััะต ะดะฐะฝะฝัะต (Unishox2)
  - ะัะฟะพะปัะทัะตััั ะดะปั: ัะบะพะฝะพะผะธั ััะฐัะธะบะฐ ะฟัะธ ะดะปะธะฝะฝัั ัะพะพะฑัะตะฝะธัั

### ะะฝัะพัะผะฐัะธั ะพ ะฝะพะดะฐั

- **`NODEINFO_APP`** (4): ะะฝัะพัะผะฐัะธั ะพ ะฝะพะดะต
  - `payload`: Protobuf ััััะบัััะฐ `User` ะธะท `mesh_pb2.User`
  - ะะพะปั:
    - `id` (string): ID ะฝะพะดั ะฒ ัะพัะผะฐัะต `!hex`
    - `long_name` (string): ะะพะปะฝะพะต ะธะผั ะฝะพะดั
    - `short_name` (string): ะะพัะพัะบะพะต ะธะผั ะฝะพะดั
    - `macaddr` (string): MAC ะฐะดัะตั
    - `hw_model` (string): ะะพะดะตะปั ััััะพะนััะฒะฐ (TBEAM, HELTEC, etc.)
    - `public_key` (string): ะัะฑะปะธัะฝัะน ะบะปัั
    - `is_unmessagable` (bool): ะะพะถะฝะพ ะปะธ ะพัะฟัะฐะฒะปััั ัะพะพะฑัะตะฝะธั

- **`POSITION_APP`** (3): ะะพะทะธัะธั ะฝะพะดั
  - `payload`: Protobuf ััััะบัััะฐ `Position` ะธะท `mesh_pb2.Position`
  - ะะพะปั:
    - `latitude_i` (int32): ะจะธัะพัะฐ ะฒ ะณัะฐะดััะฐั * 1e7 (ะดะปั ัะพัะฝะพััะธ)
    - `longitude_i` (int32): ะะพะปะณะพัะฐ ะฒ ะณัะฐะดััะฐั * 1e7
    - `altitude` (int32): ะััะพัะฐ ะฒ ะผะตััะฐั
    - `time` (uint32): Unix timestamp
    - `location_source` (enum): ะััะพัะฝะธะบ ะบะพะพัะดะธะฝะฐั (MANUAL, LOST_MANUAL, GPS, etc.)

### ะขะตะปะตะผะตััะธั

- **`TELEMETRY_APP`** (67): ะขะตะปะตะผะตััะธั ััััะพะนััะฒะฐ
  - `payload`: Protobuf ััััะบัััะฐ `Telemetry` ะธะท `mesh_pb2.Telemetry`
  - ะะพะปั:
    - `device_metrics`: ะะตััะธะบะธ ััััะพะนััะฒะฐ (ะฑะฐัะฐัะตั, ัะตะผะฟะตัะฐัััะฐ, etc.)
    - `environment_metrics`: ะะตััะธะบะธ ะพะบััะถะตะฝะธั (ัะตะผะฟะตัะฐัััะฐ, ะฒะปะฐะถะฝะพััั, ะดะฐะฒะปะตะฝะธะต)
    - `air_quality_metrics`: ะะตััะธะบะธ ะบะฐัะตััะฒะฐ ะฒะพะทะดััะฐ
    - `power_metrics`: ะะตััะธะบะธ ะฟะธัะฐะฝะธั

### ะะฐัััััะธะทะฐัะธั

- **`ROUTING_APP`** (6): ะะฝัะพัะผะฐัะธั ะพ ะผะฐัััััะธะทะฐัะธะธ
  - `payload`: Protobuf ััััะบัััะฐ `RouteDiscovery` ะธะท `mesh_pb2.RouteDiscovery`
  - ะัะฟะพะปัะทัะตััั ะดะปั: ะพะฑะฝะฐััะถะตะฝะธะต ะผะฐัััััะพะฒ, traceroute

- **`NEIGHBORINFO_APP`** (5): ะะฝัะพัะผะฐัะธั ะพ ัะพัะตะดัั
  - `payload`: Protobuf ััััะบัััะฐ ั ะธะฝัะพัะผะฐัะธะตะน ะพ ัะพัะตะดะฝะธั ะฝะพะดะฐั
  - ะัะฟะพะปัะทัะตััั ะดะปั: ะฟะพัััะพะตะฝะธะต ะบะฐััั ัะตัะธ

### ะะดะผะธะฝะธัััะธัะพะฒะฐะฝะธะต

- **`ADMIN_APP`** (64): ะะดะผะธะฝะธัััะฐัะธะฒะฝัะต ะบะพะผะฐะฝะดั
  - `payload`: Protobuf ััััะบัััะฐ `AdminMessage` ะธะท `mesh_pb2.AdminMessage`
  - ะัะฟะพะปัะทัะตััั ะดะปั: ะฝะฐัััะพะนะบะฐ ะฝะพะดั, ะธะทะผะตะฝะตะฝะธะต ะบะพะฝัะธะณััะฐัะธะธ

### ะััะณะธะต ัะธะฟั

- **`PAXCOUNTER_APP`** (65): ะกัะตััะธะบ ะปัะดะตะน (WiFi/BLE)
  - `payload`: ะะพะปะธัะตััะฒะพ ะพะฑะฝะฐััะถะตะฝะฝัั ััััะพะนััะฒ

- **`WAYPOINT_APP`** (66): ะขะพัะบะธ ะผะฐัััััะฐ
  - `payload`: Protobuf ััััะบัััะฐ `Waypoint` ะธะท `mesh_pb2.Waypoint`

- **`AUDIO_APP`** (68): ะัะดะธะพ ะดะฐะฝะฝัะต
  - `payload`: ะะฐะบะพะดะธัะพะฒะฐะฝะฝัะต ะฐัะดะธะพ ะดะฐะฝะฝัะต

- **`IP_TUNNEL_APP`** (69): IP ััะฝะฝะตะปั
  - `payload`: IP ะฟะฐะบะตัั ะดะปั ััะฝะฝะตะปะธัะพะฒะฐะฝะธั

## ะัะพะฑะตะฝะฝะพััะธ ะฟะฐััะธะฝะณะฐ

### ะะฟัะตะดะตะปะตะฝะธะต ัะธะฟะฐ ัะพะพะฑัะตะฝะธั

ะขะธะฟ ัะพะพะฑัะตะฝะธั ะพะฟัะตะดะตะปัะตััั ะฟะพ `portnum` ะฒ `decoded`:

```python
portnum = decoded.get("portnum")
if portnum:
    portnum_lower = str(portnum).lower()
    if "text_message" in portnum_lower and "compressed" not in portnum_lower:
        type = "text"
    elif "text_message_compressed" in portnum_lower:
        type = "text_compressed"
    elif "nodeinfo" in portnum_lower:
        type = "nodeinfo"
    # ... ะธ ั.ะด.
```

### ะะตะบะพะดะธัะพะฒะฐะฝะธะต payload

Payload ะดะตะบะพะดะธััะตััั ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะฟะฐ:

1. **TEXT_MESSAGE_APP**: ะััะผะพะต ะดะตะบะพะดะธัะพะฒะฐะฝะธะต UTF-8
   ```python
   text = decoded_bytes.decode("utf-8", errors="replace")
   ```

2. **TEXT_MESSAGE_COMPRESSED_APP**: ะะตะบะพะผะฟัะตััะธั Unishox2
   ```python
   import unishox2_py
   decompressed = unishox2_py.decompress(decoded_bytes)
   text = decompressed.decode("utf-8", errors="replace")
   ```

3. **NODEINFO_APP**: ะะฐััะธะฝะณ protobuf `User`
   ```python
   from meshtastic.protobuf import mesh_pb2
   user_msg = mesh_pb2.User()
   user_msg.ParseFromString(decoded_bytes)
   ```

4. **POSITION_APP**: ะะฐััะธะฝะณ protobuf `Position`
   ```python
   from meshtastic.protobuf import mesh_pb2
   position_msg = mesh_pb2.Position()
   position_msg.ParseFromString(decoded_bytes)
   # ะะพะฝะฒะตััะฐัะธั ะบะพะพัะดะธะฝะฐั: latitude = latitude_i / 1e7
   ```

### ะะฐะถะฝัะต ะทะฐะผะตัะฐะฝะธั

1. **ะะตััะฐะฝัะปะธัะพะฒะฐะฝะฝัะต ัะพะพะฑัะตะฝะธั**: ะัะธ ัะตััะฐะฝัะปััะธะธ ัะพะพะฑัะตะฝะธั:
   - `id` ะพััะฐะตััั ัะตะผ ะถะต (ะดะปั ะณััะฟะฟะธัะพะฒะบะธ)
   - `from` ะพััะฐะตััั ะพัะธะณะธะฝะฐะปัะฝัะผ ะพัะฟัะฐะฒะธัะตะปะตะผ
   - `sender` ะผะตะฝัะตััั ะฝะฐ ะฝะพะดั-ัะตััะฐะฝัะปััะพั
   - `rx_rssi`, `rx_snr`, `rx_time` ะพััะฐะถะฐัั ะฟะฐัะฐะผะตััั ะฟัะธะตะผะฐ ัะตััะฐะฝัะปััะพัะพะผ
   - `hop_limit` ัะผะตะฝััะฐะตััั ะฝะฐ 1
   - `message_type` ะผะพะถะตั ะฑััั `None`, ะตัะปะธ payload ะฝะต ะดะตะบะพะดะธััะตััั

2. **ะััะฟะฟะธัะพะฒะบะฐ ัะพะพะฑัะตะฝะธะน**: ะกะพะพะฑัะตะฝะธั ั ะพะดะธะฝะฐะบะพะฒัะผ `id` ะณััะฟะฟะธัััััั ะฟะพ ะฝะพะดะฐะผ-ะฟะพะปััะฐัะตะปัะผ ะดะปั ะพัะพะฑัะฐะถะตะฝะธั ะฒ Telegram.

3. **ะะพะพัะดะธะฝะฐัั**: ะ protobuf ะบะพะพัะดะธะฝะฐัั ััะฐะฝัััั ะบะฐะบ `latitude_i` ะธ `longitude_i` (int32), ะณะดะต ะทะฝะฐัะตะฝะธะต = ะณัะฐะดััั * 1e7. ะะปั ะฟะพะปััะตะฝะธั ะณัะฐะดััะพะฒ: `latitude = latitude_i / 1e7`.

## ะัะธะผะตัั ะธัะฟะพะปัะทะพะฒะฐะฝะธั ะฒ ะบะพะดะต

### ะะฐััะธะฝะณ protobuf ะฟะฐะบะตัะฐ

```python
from meshtastic.protobuf import mqtt_pb2
from google.protobuf.json_format import MessageToDict

envelope = mqtt_pb2.ServiceEnvelope()
envelope.ParseFromString(payload)

envelope_dict = MessageToDict(envelope, preserving_proto_field_name=True)
packet = envelope_dict.get("packet", {})
decoded = packet.get("decoded", {})

# ะะทะฒะปะตัะตะฝะธะต ะฟะพะปะตะน
message_id = packet.get("id")
from_node = packet.get("from")
sender_node = packet.get("sender")
to_node = packet.get("to")
rssi = packet.get("rx_rssi")
snr = packet.get("rx_snr")
portnum = decoded.get("portnum")
payload_b64 = decoded.get("payload")
```

### ะะตะบะพะดะธัะพะฒะฐะฝะธะต nodeinfo

```python
from meshtastic.protobuf import mesh_pb2
import base64

payload_b64 = decoded.get("payload")
decoded_bytes = base64.b64decode(payload_b64)

user_msg = mesh_pb2.User()
user_msg.ParseFromString(decoded_bytes)

node_id = user_msg.id  # "!698566d0"
long_name = user_msg.long_name  # "NCH.ST.NG.63"
short_name = user_msg.short_name  # "7777"
```

### ะะตะบะพะดะธัะพะฒะฐะฝะธะต position

```python
from meshtastic.protobuf import mesh_pb2
import base64

payload_b64 = decoded.get("payload")
decoded_bytes = base64.b64decode(payload_b64)

position_msg = mesh_pb2.Position()
position_msg.ParseFromString(decoded_bytes)

latitude = position_msg.latitude_i / 1e7  # ะะพะฝะฒะตััะฐัะธั ะฒ ะณัะฐะดััั
longitude = position_msg.longitude_i / 1e7
altitude = position_msg.altitude
```

## ะกััะปะบะธ

- [Meshtastic GitHub](https://github.com/meshtastic)
- [Meshtastic Python Library](https://github.com/meshtastic/python)
- [Meshtastic Protobuf Definitions](https://github.com/meshtastic/Meshtastic-protobufs)

