# Тестирование MQTT подключения

## Команда для подписки на топик

```bash
docker-compose exec mosquitto mosquitto_sub -h localhost -t "msh/2/json/#" -v
```

## Что должно произойти

### 1. Успешное подключение

После выполнения команды вы должны увидеть:
- **Никакого вывода** - это нормально! Команда ждет сообщений
- Курсор будет мигать, ожидая входящих сообщений
- Команда будет работать до тех пор, пока вы не нажмете `Ctrl+C`

### 2. Когда нода Meshtastic отправляет данные

Если нода настроена и отправляет сообщения, вы увидите вывод в формате:

```
msh/2/json/!12345678 {"id":12345678,"rx_time":1234567890,"from":12345678,"to":4294967295,"channel":0,"hop_limit":3,"hop_start":3,"want_ack":false,"priority":128,"rssi":-45,"snr":8.5,"payload":"SGVsbG8gV29ybGQ=","portnum":"TEXT_MESSAGE_APP"}
```

Где:
- Первая строка - это **топик** (например: `msh/2/json/!12345678`)
- Вторая строка - это **JSON сообщение** от Meshtastic ноды

### 3. Если ничего не происходит

Если команда выполнилась без ошибок, но сообщений нет:

1. **Проверьте, что нода подключена к MQTT:**
   - Откройте настройки ноды Meshtastic
   - Убедитесь, что MQTT Enabled включен
   - Проверьте, что адрес сервера указан правильно

2. **Проверьте логи Mosquitto:**
   ```bash
   docker-compose logs mosquitto
   ```
   Должны быть записи о подключении клиента (ноды)

3. **Проверьте, что нода отправляет сообщения:**
   - Отправьте тестовое сообщение через Meshtastic
   - Или проверьте, что нода активна и в сети

## Тестирование MQTT брокера

### Тест 1: Проверка работы брокера

В **первом терминале** подпишитесь на тестовый топик:
```bash
docker-compose exec mosquitto mosquitto_sub -h localhost -t "test/topic" -v
```

В **втором терминале** отправьте тестовое сообщение:
```bash
docker-compose exec mosquitto mosquitto_pub -h localhost -t "test/topic" -m "Hello MQTT"
```

**Ожидаемый результат:** В первом терминале должно появиться:
```
test/topic Hello MQTT
```

### Тест 2: Проверка подключения ноды

Проверьте логи Mosquitto на наличие подключений:
```bash
docker-compose logs -f mosquitto | grep -i "connect"
```

Когда нода подключается, вы должны увидеть:
```
New connection from <IP_ADDRESS> on port 1883
```

**Примечание:** Если логи не отображаются, убедитесь, что в `mosquitto.conf` указано `log_dest stdout`. После изменения конфигурации перезапустите контейнер:
```bash
docker-compose restart mosquitto
```

### Тест 3: Проверка всех топиков

Подпишитесь на все топики (для отладки):
```bash
docker-compose exec mosquitto mosquitto_sub -h localhost -t "#" -v
```

Это покажет все сообщения, которые публикуются в брокер.

## Возможные проблемы

### Проблема: "Error: Connection refused"

**Причина:** Mosquitto не запущен или недоступен

**Решение:**
```bash
docker-compose ps mosquitto
docker-compose up -d mosquitto
```

### Проблема: Команда зависает без вывода

**Это нормально!** Команда ждет сообщений. Если хотите убедиться, что она работает:
1. Откройте второй терминал
2. Выполните тест 1 (отправьте тестовое сообщение)
3. В первом терминале должно появиться сообщение

### Проблема: "Error: No route to host"

**Причина:** Проблемы с сетью Docker

**Решение:**
```bash
docker-compose restart mosquitto
```

### Проблема: Нода не подключается

**Проверьте:**
1. IP адрес сервера правильный
2. Порт 1883 открыт в файрволе
3. Нода и сервер в одной сети
4. Настройки MQTT в ноде сохранены

**Проверка подключения с ноды:**
- Используйте MQTT клиент на устройстве с нодой
- Или проверьте логи ноды (если доступны)

## Альтернативные способы проверки

### Через веб-интерфейс (если установлен)

Если у вас установлен MQTT Explorer или подобный инструмент:
- Host: `localhost` (или IP сервера)
- Port: `1883`
- Topic: `msh/2/json/#`

### Через Python скрипт

Создайте файл `test_mqtt.py`:
```python
import asyncio
from aiomqtt import Client

async def test_subscribe():
    async with Client("localhost", 1883) as client:
        await client.subscribe("msh/2/json/#")
        async for message in client.messages:
            print(f"{message.topic}: {message.payload.decode()}")

asyncio.run(test_subscribe())
```

Запустите:
```bash
python test_mqtt.py
```

## Ожидаемое поведение команды

| Ситуация | Поведение |
|----------|-----------|
| Команда выполнена успешно | Курсор мигает, ожидание сообщений |
| Нода отправляет сообщение | Появляется строка с топиком и JSON |
| Нода не подключена | Ничего не происходит (нормально) |
| Брокер не работает | Ошибка подключения |
| Неправильный топик | Ничего не происходит |

## Выход из команды

Для выхода из `mosquitto_sub` нажмите:
- `Ctrl+C` (Windows/Linux)
- `Ctrl+Z` затем `kill %1` (альтернативный способ)

